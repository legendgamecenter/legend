<!DOCTYPE html>
<html lang="ku">
<head>
    <meta charset="UTF-8">
    <title>Legend Game Center</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #111; color: #eee; padding: 20px; }
        .main-title { text-align: center; font-size: 48px; font-weight: bold; color: #c63636; text-shadow: 0 0 10px #000, 0 0 20px #250000; margin-bottom: 10px; }
        .switch-btn { border: none; border-radius: 8px; padding: 8px 18px; margin: 0 5px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .switch-btn.active { opacity: 1; } .switch-btn.inactive { opacity: 0.5; }
        #players, #tables { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
        .player { background: #032648; border-radius: 12px; padding: 15px; border: 6px solid rgb(8, 81, 146); text-align: center; transition: 0.3s; }
        .player.started { border: 6px solid rgb(6, 96, 6); background-color: #002005; }
        .player.paused { border: 6px solid rgb(99, 8, 8); background-color: rgb(44, 2, 2); }
        .player h4 { margin: 0 0 4px 0; font-size: 1.8em; color: #408df7; }
        .player.started h4 { color: #0fa514; }
        .player.paused h4 { color: #a72929; }
        .time { font-size: 20px; margin: 8px 0; }
        .cost { font-size: 20px; color: #ffd700; margin-bottom: 10px; }
        button { border: none; border-radius: 8px; padding: 8px 18px; font-size: 14px; color: #fff; font-weight: bold; cursor: pointer; margin: 4px; transition: 0.2s; }
        table { width: 300px; margin: 20px auto; border-collapse: collapse; color: #eee; }
        table, th, td { border: 1px solid #555; }
        th, td { padding: 8px 12px; text-align: center; }
        th { background-color: #444; }
        input, select { border-radius: 6px; border: none; padding: 6px; margin: 5px; background: #333; color: #fff; }
        .food-manager, .cafe-section, .debt-section, .sales-history-section { background-color: #1a1a1a; padding: 15px; border-radius: 10px; margin: 20px auto; max-width: 600px; text-align: center; }
        .food-manager h3, .cafe-section h3, .debt-section h3, .sales-history-section h3 { margin-top: 0; color: #00bcd4; }
        #foodMenuList li, #currentOrderList li, #debtList li { display: flex; justify-content: space-between; align-items: center; background-color: #2a2a2a; margin-bottom: 5px; padding: 8px; border-radius: 5px; }
        #foodMenuList button, .delete-food-btn { background-color: #e91e63; padding: 3px 8px; font-size: 12px; }
        .delete-food-btn, .remove-order-item-btn, .delete-sale-btn { background: none; color: #ff5252; font-size: 16px; }
        .cafe-menu-item-btn { background-color: #2196F3; margin: 4px; flex-grow: 1; }
        #cafeMenuItems { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px;}
        .start-btn, .resume-btn { background-color: #4CAF50; }
        .pause-btn { background-color: #f44336; }
        .reset-btn { background-color: #ff9800; }
        #pcBtn { background-color: #f44336; }
        #psBtn { background-color: #2196F3; }
        #cafeBtn { background-color: #9c27b0; }
        #tableBtn { background-color: #ff9800; }

        /* Sales History Styles */
        .sale-item { border-right: 5px solid; padding: 10px; margin-bottom: 10px; border-radius: 5px; text-align: right; position: relative; }
        .sale-item.cash { background-color: #0c2b0d; border-color: #4CAF50; }
        .sale-item.debt { background-color: #301010; border-color: #f44336; }
        .sale-item-header { font-weight: bold; margin-bottom: 5px; }
        .sale-item-header .type-cash { color: #4CAF50; }
        .sale-item-header .type-debt { color: #f44336; }
        .sale-item-time { font-size: 12px; color: #aaa; margin-bottom: 8px;}
        .sale-item-products { list-style-type: none; padding: 0; margin: 0; font-size: 14px; }
        .sale-item-products li { border-bottom: 1px solid #444; padding: 3px 0; }
        .sale-item-products li:last-child { border-bottom: none; }
        .delete-sale-btn { position: absolute; left: 5px; top: 5px; padding: 0; }
    </style>
</head>
<body>
    <h2 class="main-title">Legend Game Center</h2>
    
    <div style="text-align:center; margin-bottom:20px;">
        <button id="pcBtn" class="switch-btn active" onclick="switchMode('PC')">PC</button>
        <button id="psBtn" class="switch-btn inactive" onclick="switchMode('PS')">PlayStation</button>
        <button id="tableBtn" class="switch-btn inactive" onclick="switchMode('TABLE')">Ù…ÛØ²Û•Ú©Ø§Ù†</button>
        <button id="cafeBtn" class="switch-btn inactive" onclick="switchMode('CAFE')">CafÃ©</button>
    </div>
    <div id="mainControls" style="text-align:center;margin:20px;">
        <button onclick="startAll()" style="background:#4CAF50;">â–¶ Start All</button>
        <button onclick="pauseAll()" style="background:#f44336;">â¸ Pause All</button>
        <button onclick="resetAll()" style="background:#ff9800;">ğŸ”„ Reset All</button>
    </div>

    <div id="players"></div>
    <div id="tables" style="display:none;"></div>

    <!-- Cafe Section -->
    <div id="cafeSection" class="cafe-section" style="display:none;">
        <h3>â˜• Ø¨Û•Ø´ÛŒ Ú©Ø§ÙÛ</h3>
        <div id="cafeMenuItems"></div>
        <hr style="border-color: #444;">
        <h4>Ù„ÛŒØ³ØªÛŒ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ø¦ÛØ³ØªØ§</h4>
        <ul id="currentOrderList" style="list-style-type:none; padding:0;"></ul>
        <h4 style="color: #ffd700;">Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ: <span id="currentOrderTotal">0</span> Ø¯ÛŒÙ†Ø§Ø±</h4>
        <div>
            <button onclick="handleCashPayment()" style="background-color: #4CAF50;">Ù¾Ø§Ø±Û•ÛŒ Ù†Û•Ù‚Ø¯</button>
            <input type="text" id="debtorName" placeholder="Ù†Ø§ÙˆÛŒ Ù‚Û•Ø±Ø²Ø§Ø±" style="width: 150px;">
            <button onclick="handleSaveDebt()" style="background-color: #ff9800;">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù† ÙˆÛ•Ú© Ù‚Û•Ø±Ø²</button>
            <button onclick="clearCurrentOrder()" style="background-color: #f44336;">Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù„ÛŒØ³Øª</button>
        </div>
    </div>
    
    <!-- Debt Section -->
    <div id="debtSection" class="debt-section" style="display:none;">
        <h3>ğŸ§¾ Ù„ÛŒØ³ØªÛŒ Ù‚Û•Ø±Ø²Û•Ú©Ø§Ù†</h3>
        <ul id="debtList" style="list-style-type:none; padding:0;"></ul>
    </div>
    
    <!-- Sales History Section -->
    <div id="salesHistorySection" class="sales-history-section" style="display:none;">
        <h3>ğŸ“œ Ù„ÛŒØ³ØªÛŒ ÙØ±Û†Ø´ØªÙ†Û•Ú©Ø§Ù†ÛŒ Ú©Ø§ÙÛ</h3>
        <div>
            <label for="salesMonthFilter">Ù…Ø§Ù†Ú¯:</label>
            <select id="salesMonthFilter" onchange="updateSalesDayFilter()"></select>
            <label for="salesDayFilter">Ú•Û†Ú˜:</label>
            <select id="salesDayFilter" onchange="renderSalesHistory()"></select>
        </div>
        <ul id="salesHistoryList" style="list-style-type:none; padding:0; margin-top:15px;"></ul>
    </div>

    <hr style="border-color: #444; margin: 40px 0;">

    <!-- Income Sections -->
    <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
        <div style="text-align:center;">
            <h3 style="color:#eee;">--- Ø¯Ø§Ù‡Ø§ØªÛŒ ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† ---</h3>
            <h2 style="color:#ffd700;">ğŸ’° Ù‚Ø§Ø²Ø§Ù†Ø¬ÛŒ Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†Ú©Ø±Ø§Ùˆ: <span id="totalIncome">0</span> Ø¯ÛŒÙ†Ø§Ø±</h2>
            <h3 style="color:#4CAF50;">ğŸ“… Ø¯Ø§Ù‡Ø§ØªÛŒ Ø¦Û•Ù…Ú•Û†: <span id="dailyIncome">0</span> Ø¯ÛŒÙ†Ø§Ø±</h3>
            <h3 style="color:#00bcd4;">ğŸ“† Ø¯Ø§Ù‡Ø§ØªÛŒ Ø¦Û•Ù… Ù…Ø§Ù†Ú¯Û•: <span id="monthlyIncome">0</span> Ø¯ÛŒÙ†Ø§Ø±</h3>
        </div>
        <div style="text-align:center;">
            <h3 style="color:#eee;">--- Ø¯Ø§Ù‡Ø§ØªÛŒ Ù…ÛØ²Û•Ú©Ø§Ù† ---</h3>
            <h3 style="color:#4CAF50;">ğŸ“… Ø¯Ø§Ù‡Ø§ØªÛŒ Ø¦Û•Ù…Ú•Û†: <span id="tableDailyIncome">0</span> Ø¯ÛŒÙ†Ø§Ø±</h3>
            <h3 style="color:#00bcd4;">ğŸ“† Ø¯Ø§Ù‡Ø§ØªÛŒ Ø¦Û•Ù… Ù…Ø§Ù†Ú¯Û•: <span id="tableMonthlyIncome">0</span> Ø¯ÛŒÙ†Ø§Ø±</h3>
        </div>
        <div style="text-align:center;">
            <h3 style="color:#eee;">--- Ø¯Ø§Ù‡Ø§ØªÛŒ Ú©Ø§ÙÛ ---</h3>
            <h3 style="color:#4CAF50;">ğŸ“… Ø¯Ø§Ù‡Ø§ØªÛŒ Ø¦Û•Ù…Ú•Û†: <span id="cafeDailyIncome">0</span> Ø¯ÛŒÙ†Ø§Ø±</h3>
            <h3 style="color:#00bcd4;">ğŸ“† Ø¯Ø§Ù‡Ø§ØªÛŒ Ø¦Û•Ù… Ù…Ø§Ù†Ú¯Û•: <span id="cafeMonthlyIncome">0</span> Ø¯ÛŒÙ†Ø§Ø±</h3>
        </div>
    </div>

    <div style="text-align:center;margin-top:30px;">
        <h3>ğŸ“Š Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ú•Ø§Ù¾Û†Ø±Øª</h3>
        <select id="reportType">
            <option value="daily">Ø¯Ø§Ù‡Ø§ØªÛŒ Ú•Û†Ú˜Ø§Ù†Û•ÛŒ ÛŒØ§Ø±ÛŒ</option>
            <option value="monthly">Ø¯Ø§Ù‡Ø§ØªÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•ÛŒ ÛŒØ§Ø±ÛŒ</option>
            <option value="table-daily">Ø¯Ø§Ù‡Ø§ØªÛŒ Ú•Û†Ú˜Ø§Ù†Û•ÛŒ Ù…ÛØ²Û•Ú©Ø§Ù†</option>
            <option value="table-monthly">Ø¯Ø§Ù‡Ø§ØªÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•ÛŒ Ù…ÛØ²Û•Ú©Ø§Ù†</option>
            <option value="cafe-daily">Ø¯Ø§Ù‡Ø§ØªÛŒ Ú•Û†Ú˜Ø§Ù†Û•ÛŒ Ú©Ø§ÙÛ</option>
            <option value="cafe-monthly">Ø¯Ø§Ù‡Ø§ØªÛŒ Ù…Ø§Ù†Ú¯Ø§Ù†Û•ÛŒ Ú©Ø§ÙÛ</option>
        </select>
        <select id="reportList"></select>
        <button onclick="generateReport()" style="background:#9c27b0;">Ø¯Ø±ÙˆØ³ØªÚ©Ø±Ø¯Ù†ÛŒ PDF</button>
    </div>
    <table id="gameStatsTable">
        <thead><tr><th style="color:#4CAF50;">Started</th><th style="color:#f44336;">Not Started</th></tr></thead>
        <tbody><tr><td id="countStarted">0</td><td id="countNotStarted">0</td></tr></tbody>
    </table>
    <hr style="border-color: #444; margin: 40px 0;">
    <div class="food-manager">
        <h3>ğŸ“‹ Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†ÛŒ Ù„ÛŒØ³ØªÛŒ Ø®ÙˆØ§Ø±Ø¯Ù†Û•Ú©Ø§Ù†</h3>
        <div>
            <input type="text" id="newFoodName" placeholder="Ù†Ø§ÙˆÛŒ Ø®ÙˆØ§Ø±Ø¯Ù†">
            <input type="number" id="newFoodPrice" placeholder="Ù†Ø±Ø®">
            <button id="addFoodItemBtn" style="background:#4CAF50;">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ø¨Û† Ù„ÛŒØ³Øª</button>
        </div>
        <ul id="foodMenuList" style="list-style-type:none; padding:0; margin-top:15px;"></ul>
    </div>
    <script>
        let mode = 'PC';
        const numPC = 20, numPS = 14, numTables = 6;
        const pricePerHour = { 'PC': 3000, 'PS': 4500 };
        let intervals = {};
        const playersDiv = document.getElementById('players');
        const tablesDiv = document.getElementById('tables');
        const foodMenuKey = 'foodMenu';
        const debtsKey = 'cafeDebts_v2';
        const cafeSalesHistoryKey = 'cafeSalesHistory';
        let currentCafeOrder = [];
        
        // --- Key Generators ---
        function getTodayKey() { const d = new Date(); return `daily-${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`; }
        function getMonthKey() { const d = new Date(); return `monthly-${d.getFullYear()}-${d.getMonth() + 1}`; }
        function getCafeTodayKey(date = new Date()) { return `cafe-daily-${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`; }
        function getCafeMonthKey(date = new Date()) { return `cafe-monthly-${date.getFullYear()}-${date.getMonth() + 1}`; }
        function getTableTodayKey(date = new Date()) { return `table-daily-${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`; }
        function getTableMonthKey(date = new Date()) { return `table-monthly-${date.getFullYear()}-${date.getMonth() + 1}`; }

        // --- Food Menu Management ---
        function loadFoodMenu() { return JSON.parse(localStorage.getItem(foodMenuKey)) || []; }
        function saveFoodMenu(menu) {
            localStorage.setItem(foodMenuKey, JSON.stringify(menu));
            renderFoodMenu();
            populateAllPlayerDropdowns();
            renderCafeMenu();
            populateAllTableDropdowns();
        }
        function renderFoodMenu() {
            const menu = loadFoodMenu();
            const menuList = document.getElementById('foodMenuList');
            menuList.innerHTML = '';
            menu.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${item.name} - ${item.price} Ø¯ÛŒÙ†Ø§Ø±</span><button onclick="deleteFoodItem(${index})">Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>`;
                menuList.appendChild(li);
            });
        }
        function deleteFoodItem(index) {
            if (!confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¦Û•Ù… Ø®ÙˆØ§Ø±Ø¯Ù†Û• Ù„Û• Ù„ÛŒØ³ØªÛ•Ú©Û•ØŸ")) return;
            const menu = loadFoodMenu();
            menu.splice(index, 1);
            saveFoodMenu(menu);
        }
        document.getElementById('addFoodItemBtn').addEventListener('click', () => {
            const nameInput = document.getElementById('newFoodName');
            const priceInput = document.getElementById('newFoodPrice');
            const name = nameInput.value.trim();
            const price = parseInt(priceInput.value);
            if (name === '' || isNaN(price) || price <= 0) { alert("ØªÚ©Ø§ÛŒÛ• Ù†Ø§Ùˆ Ùˆ Ù†Ø±Ø®ÛÚ©ÛŒ Ø¯Ø±ÙˆØ³Øª Ø¨Ù†ÙˆÙˆØ³Û•."); return; }
            const menu = loadFoodMenu();
            menu.push({ name, price });
            saveFoodMenu(menu);
            nameInput.value = '';
            priceInput.value = '';
        });
        
        // --- Player (Game) Specific Functions ---
        function populateAllPlayerDropdowns() {
            const menu = loadFoodMenu();
            ['PC', 'PS'].forEach(m => {
                const max = m === 'PC' ? numPC : numPS;
                for (let i = 1; i <= max; i++) {
                    const select = document.getElementById(`foodSelect${i}`);
                    if (select) {
                        const currentVal = select.value;
                        select.innerHTML = '<option value="">Ø®ÙˆØ§Ø±Ø¯Ù† Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•...</option>';
                        menu.forEach((item, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${item.name} (${item.price})`;
                            select.appendChild(option);
                        });
                        select.value = currentVal;
                    }
                }
            });
        }
        function addFoodToPlayer(i) {
            const key = `${mode}${i}`;
            const select = document.getElementById(`foodSelect${i}`);
            const foodIndex = select.value;
            if (foodIndex === "") { alert("ØªÚ©Ø§ÛŒÛ• Ø®ÙˆØ§Ø±Ø¯Ù†ÛÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•."); return; }
            const menu = loadFoodMenu();
            const foodItem = menu[parseInt(foodIndex)];
            let stored = JSON.parse(localStorage.getItem(key)) || { elapsedTime: 0, startTime: 0, isRunning: false, foodItems: [] };
            if (!stored.foodItems) stored.foodItems = [];
            stored.foodItems.push({ name: foodItem.name, price: foodItem.price });
            localStorage.setItem(key, JSON.stringify(stored));
            const elapsed = (stored.elapsedTime || 0) + (stored.isRunning ? (Date.now() - stored.startTime) : 0);
            updateDisplay(i, elapsed);
            if (!stored.isRunning) toggleButtons(i, 'paused');
            updateCounts();
        }
        function deleteFoodFromPlayer(i, foodIndex) {
            const key = `${mode}${i}`;
            let stored = JSON.parse(localStorage.getItem(key));
            if (!stored || !stored.foodItems || stored.foodItems.length <= foodIndex) return;
            stored.foodItems.splice(foodIndex, 1);
            localStorage.setItem(key, JSON.stringify(stored));
            let elapsed = stored.elapsedTime || 0;
            if (stored.isRunning) elapsed += (Date.now() - stored.startTime);
            updateDisplay(i, elapsed);
            if (!stored.isRunning && !(stored.elapsedTime > 0) && stored.foodItems.length === 0) toggleButtons(i, 'reset');
            updateCounts();
        }
        
        // --- Income and Reporting ---
        function updateIncomeDisplay() {
            const daily = JSON.parse(localStorage.getItem(getTodayKey())) || 0;
            const monthly = JSON.parse(localStorage.getItem(getMonthKey())) || 0;
            document.getElementById('dailyIncome').textContent = daily;
            document.getElementById('monthlyIncome').textContent = monthly;
        }
        function updateCafeIncomeDisplay() {
            const daily = JSON.parse(localStorage.getItem(getCafeTodayKey())) || 0;
            const monthly = JSON.parse(localStorage.getItem(getCafeMonthKey())) || 0;
            document.getElementById('cafeDailyIncome').textContent = daily;
            document.getElementById('cafeMonthlyIncome').textContent = monthly;
        }
        function updateTableIncomeDisplay() {
            const daily = JSON.parse(localStorage.getItem(getTableTodayKey())) || 0;
            const monthly = JSON.parse(localStorage.getItem(getTableMonthKey())) || 0;
            document.getElementById('tableDailyIncome').textContent = daily;
            document.getElementById('tableMonthlyIncome').textContent = monthly;
        }
        function addIncome(amount) {
            if (amount <= 0) return;
            let daily = JSON.parse(localStorage.getItem(getTodayKey())) || 0;
            let monthly = JSON.parse(localStorage.getItem(getMonthKey())) || 0;
            daily += amount;
            monthly += amount;
            localStorage.setItem(getTodayKey(), JSON.stringify(daily));
            localStorage.setItem(getMonthKey(), JSON.stringify(monthly));
            updateIncomeDisplay();
        }
        function addCafeIncome(amount) {
            if (amount <= 0) return;
            let daily = JSON.parse(localStorage.getItem(getCafeTodayKey())) || 0;
            let monthly = JSON.parse(localStorage.getItem(getCafeMonthKey())) || 0;
            daily += amount;
            monthly += amount;
            localStorage.setItem(getCafeTodayKey(), JSON.stringify(daily));
            localStorage.setItem(getCafeMonthKey(), JSON.stringify(monthly));
            updateCafeIncomeDisplay();
        }
        function subtractCafeIncome(amount, timestamp) {
            if (amount <= 0) return;
            const saleDate = new Date(timestamp);
            const dailyKey = getCafeTodayKey(saleDate);
            const monthlyKey = getCafeMonthKey(saleDate);
            
            let daily = JSON.parse(localStorage.getItem(dailyKey)) || 0;
            let monthly = JSON.parse(localStorage.getItem(monthlyKey)) || 0;

            daily -= amount;
            monthly -= amount;

            localStorage.setItem(dailyKey, JSON.stringify(daily < 0 ? 0 : daily));
            localStorage.setItem(monthlyKey, JSON.stringify(monthly < 0 ? 0 : monthly));
            updateCafeIncomeDisplay();
        }
        function addTableIncome(amount) {
             if (amount <= 0) return;
            let daily = JSON.parse(localStorage.getItem(getTableTodayKey())) || 0;
            let monthly = JSON.parse(localStorage.getItem(getTableMonthKey())) || 0;
            daily += amount;
            monthly += amount;
            localStorage.setItem(getTableTodayKey(), JSON.stringify(daily));
            localStorage.setItem(getTableMonthKey(), JSON.stringify(monthly));
            updateTableIncomeDisplay();
        }
        function savePayment(i) {
            const paidInput = document.getElementById(`paid${i}`);
            const paidAmount = parseInt(paidInput.value) || 0;
            addIncome(paidAmount);
            paidInput.value = '';
            alert("Ù¾Ø§Ø±Û•Ú©Û• ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§ âœ…");
        }
        function generateReport() {
            const key = document.getElementById("reportList").value;
            if (!key) return alert("Ù‡ÛŒÚ† Ú•Ø§Ù¾Û†Ø±ØªÛÚ© Ù†ÛŒÛŒÛ•");
            const amount = JSON.parse(localStorage.getItem(key)) || 0;
            const reportTitle = document.getElementById("reportType").selectedOptions[0].text;
            const content = `<html><head><title>Report</title></head><body style="font-family:Arial;text-align:center;"><h2>Legend Game Center</h2><h3>${reportTitle}</h3><h4>${key.substring(key.indexOf('-') + 1)}</h4><h1>${amount} Ø¯ÛŒÙ†Ø§Ø±</h1></body></html>`;
            const win = window.open("", "", "width=600,height=600");
            win.document.write(content);
            win.document.close();
            win.print();
        }
        function addOption(key) {
            const list = document.getElementById("reportList");
            const option = document.createElement("option");
            option.value = key;
            option.textContent = key.substring(key.indexOf('-') + 1);
            list.appendChild(option);
        }
        function loadReportList() {
            const reportType = document.getElementById("reportType").value;
            const reportList = document.getElementById("reportList");
            reportList.innerHTML = '';
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(reportType + '-')) {
                    addOption(key);
                }
            }
        }
        document.getElementById("reportType").addEventListener("change", loadReportList);

        // --- UI Update Functions (Games) ---
        function updateDisplay(i, elapsed) {
            const key = `${mode}${i}`;
            const stored = JSON.parse(localStorage.getItem(key)) || { foodItems: [] };
            const gameCost = Math.floor((elapsed / (1000 * 60 * 60)) * pricePerHour[mode]);
            let foodCost = 0;
            const foodListDiv = document.getElementById(`foodList${i}`);
            foodListDiv.innerHTML = '';
            if (stored.foodItems && stored.foodItems.length > 0) {
                const list = document.createElement('ul');
                list.style.cssText = "padding-right: 0; margin: 5px 0; text-align: right; list-style-type: none;";
                stored.foodItems.forEach((item, index) => {
                    foodCost += item.price;
                    const listItem = document.createElement('li');
                    listItem.style.cssText = "display:flex; justify-content:space-between; align-items:center;";
                    listItem.innerHTML = `<span>â€¢ ${item.name}: ${item.price} Ø¯ÛŒÙ†Ø§Ø±</span><button class="delete-food-btn" onclick="deleteFoodFromPlayer(${i}, ${index})">âŒ</button>`;
                    list.appendChild(listItem);
                });
                foodListDiv.appendChild(list);
            }
            const totalCost = gameCost + foodCost;
            document.getElementById(`time${i}`).textContent = format(elapsed);
            document.getElementById(`gameCost${i}`).textContent = `ğŸ•¹ï¸ ${gameCost} Ø¯ÛŒÙ†Ø§Ø±`;
            document.getElementById(`foodCost${i}`).textContent = `ğŸ” ${foodCost} Ø¯ÛŒÙ†Ø§Ø±`;
            document.getElementById(`totalCost${i}`).textContent = `ğŸ’° Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ: ${totalCost} Ø¯ÛŒÙ†Ø§Ø±`;
            updateTotalIncome();
        }
        function updateTotalIncome() {
            let total = 0;
            ['PC', 'PS'].forEach(m => {
                const max = m === 'PC' ? numPC : numPS;
                for (let i = 1; i <= max; i++) {
                    const data = JSON.parse(localStorage.getItem(`${m}${i}`));
                    if (!data) continue;
                    let elapsed = data.elapsedTime || 0;
                    if (data.isRunning) elapsed += Date.now() - data.startTime;
                    total += Math.floor((elapsed / (1000 * 60 * 60)) * pricePerHour[m]);
                    if (data.foodItems) data.foodItems.forEach(item => total += item.price);
                }
            });
            document.getElementById('totalIncome').textContent = total;
        }
        function toggleButtons(i, state) {
            const box = document.getElementById(`playerBox${i}`);
            const start = document.getElementById(`startBtn${i}`);
            const pause = document.getElementById(`pauseBtn${i}`);
            const resume = document.getElementById(`resumeBtn${i}`);
            const reset = document.getElementById(`resetBtn${i}`);
            start.style.display = (state === 'reset') ? 'inline-block' : 'none';
            pause.style.display = (state === 'running') ? 'inline-block' : 'none';
            resume.style.display = (state === 'paused') ? 'inline-block' : 'none';
            reset.style.display = (state !== 'reset') ? 'inline-block' : 'none';
            box.classList.remove('started', 'paused');
            if (state === 'running') box.classList.add('started');
            if (state === 'paused') box.classList.add('paused');
        }
        function updateCounts() {
            let started = 0;
            if (mode === 'PC' || mode === 'PS') {
                const max = mode === 'PC' ? numPC : numPS;
                for (let i = 1; i <= max; i++) {
                    const data = JSON.parse(localStorage.getItem(`${mode}${i}`));
                    if (data && (data.isRunning || (data.elapsedTime && data.elapsedTime > 0) || (data.foodItems && data.foodItems.length > 0))) {
                         started++;
                    }
                }
                document.getElementById('countStarted').textContent = started;
                document.getElementById('countNotStarted').textContent = max - started;
            }
        }
        
        // --- Core Timer Logic (Games) ---
        function runInterval(i) {
            const key = `${mode}${i}`;
            if (intervals[key]) clearInterval(intervals[key]);
            intervals[key] = setInterval(() => {
                const data = JSON.parse(localStorage.getItem(key));
                if (!data || !data.isRunning) { clearInterval(intervals[key]); return; }
                const totalElapsed = (data.elapsedTime || 0) + (Date.now() - data.startTime);
                updateDisplay(i, totalElapsed);
            }, 1000);
        }
        function startTimer(i) {
            const key = `${mode}${i}`;
            const data = { startTime: Date.now(), elapsedTime: 0, isRunning: true, foodItems: [] };
            localStorage.setItem(key, JSON.stringify(data));
            toggleButtons(i, 'running');
            runInterval(i);
            updateCounts();
        }
        function pauseTimer(i) {
            const key = `${mode}${i}`;
            let data = JSON.parse(localStorage.getItem(key));
            if (!data || !data.isRunning) return;
            data.elapsedTime += (Date.now() - data.startTime);
            data.isRunning = false;
            localStorage.setItem(key, JSON.stringify(data));
            if (intervals[key]) clearInterval(intervals[key]);
            toggleButtons(i, 'paused');
            updateCounts();
        }
        function resumeTimer(i) {
            const key = `${mode}${i}`;
            let data = JSON.parse(localStorage.getItem(key));
            if (!data || data.isRunning) return;
            data.startTime = Date.now();
            data.isRunning = true;
            localStorage.setItem(key, JSON.stringify(data));
            toggleButtons(i, 'running');
            runInterval(i);
            updateCounts();
        }
        function resetTimer(i, force = false) {
            const key = `${mode}${i}`;
            const stored = JSON.parse(localStorage.getItem(key));
            if (stored && !force) {
                let msg = `(${mode} ${i})`;
                if (stored.foodItems && stored.foodItems.length > 0) {
                    if (!confirm(`Ø¦Û•Ù… ÛŒØ§Ø±ÛŒØ²Ø§Ù†Û• ${msg} Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒ Ø®ÙˆØ§Ø±Ø¯Ù†ÛŒ Ù‡Û•ÛŒÛ•ØŒ Ø¯ÚµÙ†ÛŒØ§ÛŒØªØŸ`)) return;
                } else if (stored.isRunning || stored.elapsedTime > 0) {
                    if (!confirm(`Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ú©Ø§ØªÛŒ ÛŒØ§Ø±ÛŒØ²Ø§Ù†ÛŒ ${msg}ØŸ`)) return;
                }
            }
            if (intervals[key]) clearInterval(intervals[key]);
            localStorage.removeItem(key);
            updateDisplay(i, 0);
            toggleButtons(i, 'reset');
            updateCounts();
        }
        
        // --- Control All Buttons Logic (Games) ---
        function startAll() {
            if (mode !== 'PC' && mode !== 'PS') return;
            const max = mode === 'PC' ? numPC : numPS;
            for (let i = 1; i <= max; i++) {
                const key = `${mode}${i}`;
                const data = JSON.parse(localStorage.getItem(key));
                if (!data || (!data.isRunning && !(data.elapsedTime > 0))) {
                    startTimer(i);
                } else if (data && !data.isRunning) {
                    resumeTimer(i);
                }
            }
        }
        function pauseAll() {
            if (mode !== 'PC' && mode !== 'PS') return;
            const max = mode === 'PC' ? numPC : numPS;
            for (let i = 1; i <= max; i++) {
                pauseTimer(i);
            }
        }
        function resetAll() {
            if (mode !== 'PC' && mode !== 'PS') return;
            if (confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ú©Ø§Øª Ùˆ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ø¦Û•Ù… Ø¨Û•Ø´Û•ØŸ")) {
                const max = mode === 'PC' ? numPC : numPS;
                for (let i = 1; i <= max; i++) {
                    resetTimer(i, true);
                }
            }
        }
        
        // --- Page Initialization and Mode Switching ---
        function loadPlayer(i) {
            const key = `${mode}${i}`;
            const div = document.createElement('div');
            div.className = 'player';
            div.id = `playerBox${i}`;
            div.innerHTML = `
                <h4>${mode} ${i}</h4>
                <div class="time" id="time${i}">00:00</div>
                <div style="display: flex; justify-content: space-between; font-size: 14px; color: #c5c5c5; padding: 0 10px; margin-top: 8px;">
                    <span id="gameCost${i}">ğŸ•¹ï¸ 0 Ø¯ÛŒÙ†Ø§Ø±</span>
                    <span id="foodCost${i}">ğŸ” 0 Ø¯ÛŒÙ†Ø§Ø±</span>
                </div>
                <div class="cost" style="margin-top: 8px; font-size: 18px;" id="totalCost${i}">ğŸ’° Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ: 0 Ø¯ÛŒÙ†Ø§Ø±</div>
                <div id="foodList${i}" style="text-align:right; font-size:13px; margin-bottom:8px; color: #cfcfcf;"></div>
                <div style="margin-bottom:10px;">
                    <select id="foodSelect${i}" style="width: 55%; box-sizing: border-box;"></select>
                    <button onclick="addFoodToPlayer(${i})" style="background:#00bcd4; width: 35%; box-sizing: border-box; vertical-align: top;">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†</button>
                </div>
                <hr style="border:0; border-top: 1px solid #444; margin: 10px 0;">
                <input type="number" id="paid${i}" placeholder="Ù¾Ø§Ø±Û•ÛŒ ÙˆÛ•Ø±Ú¯ÛŒØ±Ø§Ùˆ">
                <button onclick="savePayment(${i})" style="background:#2196F3;">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†</button><br>
                <button id="startBtn${i}" class="start-btn">Start</button>
                <button id="pauseBtn${i}" class="pause-btn" style="display:none;">Pause</button>
                <button id="resumeBtn${i}" class="resume-btn" style="display:none;">Resume</button>
                <button id="resetBtn${i}" class="reset-btn" style="display:none;">Reset</button>
            `;
            playersDiv.appendChild(div);
            
            document.getElementById(`startBtn${i}`).onclick = () => startTimer(i);
            document.getElementById(`pauseBtn${i}`).onclick = () => pauseTimer(i);
            document.getElementById(`resumeBtn${i}`).onclick = () => resumeTimer(i);
            document.getElementById(`resetBtn${i}`).onclick = () => resetTimer(i, false);
            
            const stored = JSON.parse(localStorage.getItem(key));
            if (stored) {
                if (stored.isRunning) {
                    const currentElapsed = (stored.elapsedTime || 0) + (Date.now() - stored.startTime);
                    updateDisplay(i, currentElapsed);
                    toggleButtons(i, 'running');
                    runInterval(i);
                } else {
                    updateDisplay(i, stored.elapsedTime || 0);
                    if ((stored.elapsedTime || 0) > 0 || (stored.foodItems && stored.foodItems.length > 0)) {
                        toggleButtons(i, 'paused');
                    } else { toggleButtons(i, 'reset'); }
                }
            } else { toggleButtons(i, 'reset'); }
        }
        function renderPlayers() {
            playersDiv.innerHTML = '';
            const max = mode === 'PC' ? numPC : numPS;
            for (let i = 1; i <= max; i++) loadPlayer(i);
            populateAllPlayerDropdowns();
            updateCounts();
            updateTotalIncome();
        }

        // --- Cafe, Debt, and Sales History Functions ---
        function renderCafeMenu() {
            const menu = loadFoodMenu();
            const menuDiv = document.getElementById('cafeMenuItems');
            menuDiv.innerHTML = '';
            menu.forEach(item => {
                const btn = document.createElement('button');
                btn.className = 'cafe-menu-item-btn';
                btn.textContent = `${item.name} (${item.price})`;
                btn.onclick = () => addToCafeOrder(item);
                menuDiv.appendChild(btn);
            });
        }
        function addToCafeOrder(item) {
            currentCafeOrder.push(item);
            renderCurrentOrder();
        }
        function removeFromCafeOrder(index) {
            currentCafeOrder.splice(index, 1);
            renderCurrentOrder();
        }
        function renderCurrentOrder() {
            const orderList = document.getElementById('currentOrderList');
            const totalSpan = document.getElementById('currentOrderTotal');
            orderList.innerHTML = '';
            let total = 0;
            currentCafeOrder.forEach((item, index) => {
                total += item.price;
                const li = document.createElement('li');
                li.innerHTML = `<span>${item.name} - ${item.price} Ø¯ÛŒÙ†Ø§Ø±</span><button class="remove-order-item-btn" onclick="removeFromCafeOrder(${index})">âŒ</button>`;
                orderList.appendChild(li);
            });
            totalSpan.textContent = total;
        }
        function clearCurrentOrder() {
            if (confirm('Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ØŸ')) {
                currentCafeOrder = [];
                renderCurrentOrder();
            }
        }
        function saveSale(saleData) {
            const salesHistory = JSON.parse(localStorage.getItem(cafeSalesHistoryKey)) || [];
            salesHistory.unshift(saleData);
            localStorage.setItem(cafeSalesHistoryKey, JSON.stringify(salesHistory));
        }
        function handleCashPayment() {
            const total = currentCafeOrder.reduce((sum, item) => sum + item.price, 0);
            if (total <= 0) { alert('Ù‡ÛŒÚ† Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒÛ•Ú© Ù†ÛŒÛŒÛ•!'); return; }
            if (confirm(`Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ: ${total} Ø¯ÛŒÙ†Ø§Ø±. Ù¾Ø§Ø±Û•Ú©Û• Ø¨Û• Ù†Û•Ù‚Ø¯ ÙˆÛ•Ø±Ø¨Ú¯ÛŒØ±ÛØªØŸ`)) {
                addCafeIncome(total);
                saveSale({
                    id: 'sale-' + Date.now(),
                    type: 'cash',
                    items: [...currentCafeOrder],
                    total: total,
                    timestamp: new Date().toISOString()
                });
                currentCafeOrder = [];
                renderCurrentOrder();
                updateSalesFilters();
                alert('Ù¾Ø§Ø±Û•Ú©Û• Ø¨Û† Ø¯Ø§Ù‡Ø§ØªÛŒ Ú©Ø§ÙÛ ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§.');
            }
        }
        function handleSaveDebt() {
            const debtorNameInput = document.getElementById('debtorName');
            const name = debtorNameInput.value.trim();
            const normalizedName = name.toLowerCase();
            const total = currentCafeOrder.reduce((sum, item) => sum + item.price, 0);
            if (total <= 0) { alert('Ù‡ÛŒÚ† Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒÛ•Ú© Ù†ÛŒÛŒÛ•!'); return; }
            if (name === '') { alert('ØªÚ©Ø§ÛŒÛ• Ù†Ø§ÙˆÛŒ Ù‚Û•Ø±Ø²Ø§Ø± Ø¨Ù†ÙˆÙˆØ³Û•.'); return; }
            if (confirm(`ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†ÛŒ ${total} Ø¯ÛŒÙ†Ø§Ø± ÙˆÛ•Ú© Ù‚Û•Ø±Ø² Ù„Û•Ø³Û•Ø± "${name}"ØŸ`)) {
                const saleId = 'sale-' + Date.now();
                const debts = JSON.parse(localStorage.getItem(debtsKey)) || {};
                
                if (debts[normalizedName]) {
                    debts[normalizedName].amount += total;
                    debts[normalizedName].saleIds.push(saleId);
                } else {
                    debts[normalizedName] = {
                        displayName: name,
                        amount: total,
                        saleIds: [saleId]
                    };
                }
                localStorage.setItem(debtsKey, JSON.stringify(debts));
                
                saveSale({
                    id: saleId,
                    type: 'debt',
                    debtorName: name,
                    items: [...currentCafeOrder],
                    total: total,
                    timestamp: new Date().toISOString()
                });

                currentCafeOrder = [];
                renderCurrentOrder();
                debtorNameInput.value = '';
                renderDebtList();
                updateSalesFilters();
                alert('Ù‚Û•Ø±Ø²Û•Ú©Û• Ø¨Û• Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆÛŒÛŒ ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§.');
            }
        }
        function renderDebtList() {
            const debts = JSON.parse(localStorage.getItem(debtsKey)) || {};
            const debtListUl = document.getElementById('debtList');
            debtListUl.innerHTML = '';
            Object.keys(debts).forEach(normalizedName => {
                const debt = debts[normalizedName];
                const li = document.createElement('li');
                li.innerHTML = `
                    <span style="flex-grow:1; text-align:right;">
                        <strong>${debt.displayName}</strong> - <span style="color:#ffd700;">${debt.amount} Ø¯ÛŒÙ†Ø§Ø±</span>
                    </span>
                    <button onclick="settleDebt('${normalizedName}')" style="background-color:#4CAF50; margin-right:5px;">Ø¯Ø§Ù†Û•ÙˆÛ•ÛŒ Ù‚Û•Ø±Ø²</button>
                    <button onclick="deleteDebt('${normalizedName}')" style="background-color:#f44336; margin-left:5px;">Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù‚Û•Ø±Ø²</button>
                `;
                debtListUl.appendChild(li);
            });
        }
        function settleDebt(normalizedName) {
             const debts = JSON.parse(localStorage.getItem(debtsKey)) || {};
             const debtToSettle = debts[normalizedName];
             if (!debtToSettle) return;

             if (confirm(`Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ù‡Û•Ù…ÙˆÙˆ Ù‚Û•Ø±Ø²ÛŒ "${debtToSettle.displayName}" Ø¨Û• Ø¨Ú•ÛŒ ${debtToSettle.amount} Ø¯ÛŒÙ†Ø§Ø±ØŸ`)) {
                 addCafeIncome(debtToSettle.amount);
                 
                 const salesHistory = JSON.parse(localStorage.getItem(cafeSalesHistoryKey)) || [];
                 debtToSettle.saleIds.forEach(saleId => {
                     const saleIndex = salesHistory.findIndex(s => s.id === saleId);
                     if (saleIndex !== -1) {
                         salesHistory[saleIndex].type = 'cash';
                         salesHistory[saleIndex].settled = true;
                     }
                 });
                 localStorage.setItem(cafeSalesHistoryKey, JSON.stringify(salesHistory));

                 delete debts[normalizedName];
                 localStorage.setItem(debtsKey, JSON.stringify(debts));
                 
                 renderDebtList();
                 renderSalesHistory();
                 alert('Ù‚Û•Ø±Ø²Û•Ú©Û• Ø¯Ø±Ø§ÛŒÛ•ÙˆÛ• Ùˆ Ø¯Ø§Ù‡Ø§ØªÛŒ Ú©Ø§ÙÛ Ø²ÛŒØ§Ø¯Ú©Ø±Ø§.');
             }
        }
        function deleteDebt(normalizedName) {
            const debts = JSON.parse(localStorage.getItem(debtsKey)) || {};
            const debtToDelete = debts[normalizedName];
            if (!debtToDelete) return;

            if (confirm(`Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ **Ù‡Û•Ù…ÙˆÙˆ** Ù‚Û•Ø±Ø²ÛŒ "${debtToDelete.displayName}" Ø¨Û•Ø¨Û ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ù¾Ø§Ø±Û•ØŸ\nØ¦Û•Ù… Ú©Ø±Ø¯Ø§Ø±Û• Ù¾Ø§Ø´Ú¯Û•Ø²Ø¨ÙˆÙˆÙ†Û•ÙˆÛ•ÛŒ Ù†ÛŒÛŒÛ• Ùˆ ØªÛ†Ù…Ø§Ø±Û•Ú©Ø§Ù†ÛŒ ÙØ±Û†Ø´ØªÙ†ÛŒØ´ Ø¯Û•Ø³Ú•ÛØªÛ•ÙˆÛ•.`)) {
                let salesHistory = JSON.parse(localStorage.getItem(cafeSalesHistoryKey)) || [];
                const saleIdsToDelete = new Set(debtToDelete.saleIds);
                const updatedSalesHistory = salesHistory.filter(s => !saleIdsToDelete.has(s.id));
                localStorage.setItem(cafeSalesHistoryKey, JSON.stringify(updatedSalesHistory));

                delete debts[normalizedName];
                localStorage.setItem(debtsKey, JSON.stringify(debts));
                
                renderDebtList();
                updateSalesFilters();
                alert('Ù‚Û•Ø±Ø²Û•Ú©Û• Ùˆ ØªÛ†Ù…Ø§Ø±Û•Ú©Ø§Ù†ÛŒ ÙØ±Û†Ø´ØªÙ†ÛŒ Ù¾Û•ÛŒÙˆÛ•Ø³Øª Ù¾ÛÛŒÛ•ÙˆÛ• Ø³Ú•Ø¯Ø±Ø§Ù†Û•ÙˆÛ•.');
            }
        }
        function formatSaleTimestamp(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('ku-IQ');
        }
        function deleteSaleFromHistory(saleId) {
            let salesHistory = JSON.parse(localStorage.getItem(cafeSalesHistoryKey)) || [];
            const saleIndex = salesHistory.findIndex(s => s.id === saleId);

            if (saleIndex === -1) return;

            const saleToDelete = salesHistory[saleIndex];

            if (saleToDelete.type === 'debt') {
                alert(`Ù†Ø§ØªÙˆØ§Ù†ÛŒØª ÙØ±Û†Ø´ØªÙ†ÛÚ©ÛŒ Ù‚Û•Ø±Ø² Ø¨Û• ØªÛ•Ù†Ù‡Ø§ Ø¨Ø³Ú•ÛŒØªÛ•ÙˆÛ•.\nØªÚ©Ø§ÛŒÛ• Ù‡Û•Ù…ÙˆÙˆ Ù‚Û•Ø±Ø²ÛŒ "${saleToDelete.debtorName}" Ù„Û• Ù„ÛŒØ³ØªÛŒ Ù‚Û•Ø±Ø²Û•Ú©Ø§Ù†Û•ÙˆÛ• Ø¨Ø³Ú•Û•ÙˆÛ•.`);
                return;
            }

            if (confirm(`Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¦Û•Ù… ØªÛ†Ù…Ø§Ø±Û•ÛŒ ÙØ±Û†Ø´ØªÙ†ØŸ\nØ¦Û•Ù… Ú©Ø±Ø¯Ø§Ø±Û• ÙˆØ§ Ø¯Û•Ú©Ø§Øª Ø¨Ú•ÛŒ ${saleToDelete.total} Ø¯ÛŒÙ†Ø§Ø± Ù„Û• Ø¯Ø§Ù‡Ø§Øª Ú©Û•Ù… Ø¨Ú©Ø±ÛØªÛ•ÙˆÛ•.`)) {
                subtractCafeIncome(saleToDelete.total, saleToDelete.timestamp);

                salesHistory.splice(saleIndex, 1);
                localStorage.setItem(cafeSalesHistoryKey, JSON.stringify(salesHistory));
                updateSalesFilters();
                alert("ØªÛ†Ù…Ø§Ø±ÛŒ ÙØ±Û†Ø´ØªÙ†Û•Ú©Û• Ø³Ú•Ø§ÛŒÛ•ÙˆÛ• Ùˆ Ø¨Ú•Û•Ú©Û•ÛŒ Ù„Û• Ø¯Ø§Ù‡Ø§Øª Ú©Û•Ù…Ú©Ø±Ø§ÛŒÛ•ÙˆÛ•.");
            }
        }
        function renderSalesHistory() {
            const salesHistory = JSON.parse(localStorage.getItem(cafeSalesHistoryKey)) || [];
            const historyListUl = document.getElementById('salesHistoryList');
            const monthFilter = document.getElementById('salesMonthFilter').value;
            const dayFilter = document.getElementById('salesDayFilter').value;
            historyListUl.innerHTML = '';

            const filteredSales = salesHistory.filter(sale => {
                if (monthFilter === 'all') return true;
                const saleDate = new Date(sale.timestamp);
                const saleMonth = `${saleDate.getFullYear()}/${String(saleDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (saleMonth !== monthFilter) return false;
                
                if (dayFilter === 'all') return true;

                const saleDay = String(saleDate.getDate()).padStart(2, '0');
                return saleDay === dayFilter;
            });

            filteredSales.forEach(sale => {
                const li = document.createElement('li');
                li.className = `sale-item ${sale.type}`;
                
                let typeText;
                if (sale.type === 'cash' && sale.settled) {
                    typeText = `<span class="type-cash">Ù†Û•Ù‚Ø¯</span> (Ù‚Û•Ø±Ø²ÛŒ Ù¾ÛØ´ÙˆÙˆÛŒ: ${sale.debtorName})`;
                } else if (sale.type === 'cash') {
                    typeText = `<span class="type-cash">Ù†Û•Ù‚Ø¯</span>`;
                } else {
                    typeText = `<span class="type-debt">Ù‚Û•Ø±Ø²</span> (Ù†Ø§ÙˆÛŒ Ù‚Û•Ø±Ø²Ø§Ø±: ${sale.debtorName})`;
                }

                let productsHtml = '<ul class="sale-item-products">';
                sale.items.forEach(p => {
                    productsHtml += `<li>${p.name} - ${p.price} Ø¯ÛŒÙ†Ø§Ø±</li>`;
                });
                productsHtml += '</ul>';

                li.innerHTML = `
                    <button class="delete-sale-btn" onclick="deleteSaleFromHistory('${sale.id}')">âŒ</button>
                    <div class="sale-item-header">
                        ${typeText} - Ú©Û†ÛŒ Ú¯Ø´ØªÛŒ: ${sale.total} Ø¯ÛŒÙ†Ø§Ø±
                    </div>
                    <div class="sale-item-time">${formatSaleTimestamp(sale.timestamp)}</div>
                    ${productsHtml}
                `;
                historyListUl.appendChild(li);
            });
        }
        function updateSalesFilters() {
            const salesHistory = JSON.parse(localStorage.getItem(cafeSalesHistoryKey)) || [];
            const monthFilterSelect = document.getElementById('salesMonthFilter');
            
            const uniqueMonths = [...new Set(salesHistory.map(s => {
                const d = new Date(s.timestamp);
                return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}`;
            }))].sort().reverse();
            
            const selectedMonth = monthFilterSelect.value;
            
            monthFilterSelect.innerHTML = '<option value="all">Ù‡Û•Ù…ÙˆÙˆ Ù…Ø§Ù†Ú¯Û•Ú©Ø§Ù†</option>';
            uniqueMonths.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilterSelect.appendChild(option);
            });

            if ([...monthFilterSelect.options].some(opt => opt.value === selectedMonth)) {
                monthFilterSelect.value = selectedMonth;
            }

            updateSalesDayFilter();
        }
        function updateSalesDayFilter() {
            const salesHistory = JSON.parse(localStorage.getItem(cafeSalesHistoryKey)) || [];
            const monthFilter = document.getElementById('salesMonthFilter').value;
            const dayFilterSelect = document.getElementById('salesDayFilter');
            const selectedDay = dayFilterSelect.value;

            dayFilterSelect.innerHTML = '<option value="all">Ù‡Û•Ù…ÙˆÙˆ Ú•Û†Ú˜Û•Ú©Ø§Ù†</option>';
            
            if (monthFilter !== 'all') {
                 const uniqueDays = [...new Set(salesHistory
                    .filter(s => {
                        const d = new Date(s.timestamp);
                        return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}` === monthFilter;
                    })
                    .map(s => String(new Date(s.timestamp).getDate()).padStart(2, '0'))
                )].sort((a,b) => b - a);

                uniqueDays.forEach(day => {
                    const option = document.createElement('option');
                    option.value = day;
                    option.textContent = day;
                    dayFilterSelect.appendChild(option);
                });

                if ([...dayFilterSelect.options].some(opt => opt.value === selectedDay)) {
                    dayFilterSelect.value = selectedDay;
                }
            }
            renderSalesHistory();
        }

        // --- Table Section Functions ---
        function renderTables() {
            tablesDiv.innerHTML = '';
            for (let i = 1; i <= numTables; i++) {
                loadTable(i);
            }
            populateAllTableDropdowns();
        }
        function loadTable(i) {
            const key = `TABLE${i}`;
            const div = document.createElement('div');
            div.className = 'player';
            div.id = `tableBox${i}`;
            div.innerHTML = `
                <h4>Ù…ÛØ²ÛŒ ${i}</h4>
                <div class="cost" id="tableCost${i}">ğŸ’° 0 Ø¯ÛŒÙ†Ø§Ø±</div>
                <div id="tableFoodList${i}" style="text-align:right; font-size:13px; margin-bottom:8px; color: #cfcfcf;"></div>
                <div style="margin-bottom:10px;">
                    <select id="tableFoodSelect${i}" style="width: 55%; box-sizing: border-box;"></select>
                    <button onclick="addFoodToTable(${i})" style="background-color: #00bcd4; width: 35%; box-sizing: border-box; vertical-align: top;">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†</button>
                </div>
                <hr style="border:0; border-top: 1px solid #444; margin: 10px 0;">
                <input type="number" id="tablePaid${i}" placeholder="Ù¾Ø§Ø±Û•ÛŒ ÙˆÛ•Ø±Ú¯ÛŒØ±Ø§Ùˆ">
                <button onclick="saveTablePayment(${i})" style="background:#2196F3;">ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†</button><br>
                <button id="startTableBtn${i}" class="start-btn">Ø¯Û•Ø³ØªÙ¾ÛÚ©</button>
                <button id="stopTableBtn${i}" class="pause-btn" style="display:none;">ÙˆÛ•Ø³ØªØ§Ù†</button>
                <button id="resetTableBtn${i}" class="reset-btn" style="display:none;">Reset</button>
            `;
            tablesDiv.appendChild(div);

            document.getElementById(`startTableBtn${i}`).onclick = () => startTable(i);
            document.getElementById(`stopTableBtn${i}`).onclick = () => stopTable(i);
            document.getElementById(`resetTableBtn${i}`).onclick = () => resetTable(i);

            const stored = JSON.parse(localStorage.getItem(key));
            updateTableDisplay(i); 

            if (stored && stored.isStarted) {
                toggleTableVisuals(i, 'started');
            } else {
                toggleTableVisuals(i, 'stopped');
            }
        }
        function populateAllTableDropdowns() {
            const menu = loadFoodMenu();
            for (let i = 1; i <= numTables; i++) {
                const select = document.getElementById(`tableFoodSelect${i}`);
                if (select) {
                    select.innerHTML = '<option value="">Ø®ÙˆØ§Ø±Ø¯Ù† Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•...</option>';
                    menu.forEach((item, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${item.name} (${item.price})`;
                        select.appendChild(option);
                    });
                }
            }
        }
        function updateTableDisplay(i) {
            const key = `TABLE${i}`;
            const stored = JSON.parse(localStorage.getItem(key)) || { foodItems: [] };
            let foodCost = 0;
            const foodListDiv = document.getElementById(`tableFoodList${i}`);
            foodListDiv.innerHTML = '';
            if (stored.foodItems && stored.foodItems.length > 0) {
                const list = document.createElement('ul');
                list.style.cssText = "padding-right: 0; margin: 5px 0; text-align: right; list-style-type: none;";
                stored.foodItems.forEach((item, index) => {
                    foodCost += item.price;
                    const listItem = document.createElement('li');
                    listItem.style.cssText = "display:flex; justify-content:space-between; align-items:center;";
                    listItem.innerHTML = `<span>â€¢ ${item.name}: ${item.price} Ø¯ÛŒÙ†Ø§Ø±</span><button class="delete-food-btn" onclick="deleteFoodFromTable(${i}, ${index})">âŒ</button>`;
                    list.appendChild(listItem);
                });
                foodListDiv.appendChild(list);
            }
            document.getElementById(`tableCost${i}`).textContent = `ğŸ’° ${foodCost} Ø¯ÛŒÙ†Ø§Ø±`;
        }
        function addFoodToTable(i) {
            const key = `TABLE${i}`;
            const select = document.getElementById(`tableFoodSelect${i}`);
            const foodIndex = select.value;
            if (foodIndex === "") { alert("ØªÚ©Ø§ÛŒÛ• Ø®ÙˆØ§Ø±Ø¯Ù†ÛÚ© Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•."); return; }
            const menu = loadFoodMenu();
            const foodItem = menu[parseInt(foodIndex)];
            let stored = JSON.parse(localStorage.getItem(key)) || { foodItems: [], isStarted: false };
            stored.foodItems.push({ name: foodItem.name, price: foodItem.price });
            localStorage.setItem(key, JSON.stringify(stored));
            updateTableDisplay(i);
        }
        function deleteFoodFromTable(i, foodIndex) {
            const key = `TABLE${i}`;
            let stored = JSON.parse(localStorage.getItem(key));
            if (!stored || !stored.foodItems || stored.foodItems.length <= foodIndex) return;
            stored.foodItems.splice(foodIndex, 1);
            localStorage.setItem(key, JSON.stringify(stored));
            updateTableDisplay(i);
        }
        function saveTablePayment(i) {
            const key = `TABLE${i}`;
            const paidInput = document.getElementById(`tablePaid${i}`);
            let paidAmount = parseInt(paidInput.value) || 0;
            const stored = JSON.parse(localStorage.getItem(key)) || { foodItems: [] };
            const totalCost = stored.foodItems.reduce((sum, item) => sum + item.price, 0);

            if (paidAmount <= 0) { paidAmount = totalCost; }
            if (paidAmount <= 0) { alert("Ù‡ÛŒÚ† Ø¨Ú•ÛÚ© Ù†ÛŒÛŒÛ• Ø¨Û† ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†!"); return; }

            addTableIncome(paidAmount);
            localStorage.removeItem(key);
            paidInput.value = '';
            updateTableDisplay(i);
            toggleTableVisuals(i, 'stopped');
            alert("Ù¾Ø§Ø±Û•Ú©Û• Ø¨Û† Ø¯Ø§Ù‡Ø§ØªÛŒ Ù…ÛØ²Û•Ú©Ø§Ù† ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§ âœ…");
        }
        function resetTable(i) {
            if (confirm(`Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ø¯Ø§ÙˆØ§Ú©Ø§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ù…ÛØ²ÛŒ ${i}ØŸ`)) {
                const key = `TABLE${i}`;
                localStorage.removeItem(key);
                updateTableDisplay(i);
                toggleTableVisuals(i, 'stopped');
            }
        }
        function startTable(i) {
            const key = `TABLE${i}`;
            let data = JSON.parse(localStorage.getItem(key)) || { foodItems: [], isStarted: false };
            data.isStarted = true;
            localStorage.setItem(key, JSON.stringify(data));
            toggleTableVisuals(i, 'started');
        }
        function stopTable(i) {
            const key = `TABLE${i}`;
            let data = JSON.parse(localStorage.getItem(key));
            if (!data) return;
            data.isStarted = false;
            localStorage.setItem(key, JSON.stringify(data));
            toggleTableVisuals(i, 'stopped');
        }
        function toggleTableVisuals(i, state) {
            const box = document.getElementById(`tableBox${i}`);
            const startBtn = document.getElementById(`startTableBtn${i}`);
            const stopBtn = document.getElementById(`stopTableBtn${i}`);
            const resetBtn = document.getElementById(`resetTableBtn${i}`);
            
            box.classList.remove('started');

            if (state === 'started') {
                box.classList.add('started');
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                resetBtn.style.display = 'inline-block';
            } else { // 'stopped'
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                
                const key = `TABLE${i}`;
                const data = JSON.parse(localStorage.getItem(key));
                if (data && data.foodItems && data.foodItems.length > 0) {
                    resetBtn.style.display = 'inline-block';
                } else {
                    resetBtn.style.display = 'none';
                }
            }
        }
        
        // --- Main Mode Switcher ---
        function switchMode(m) {
            Object.values(intervals).forEach(clearInterval);
            intervals = {};
            mode = m;

            document.getElementById('pcBtn').className = m === 'PC' ? 'switch-btn active' : 'switch-btn inactive';
            document.getElementById('psBtn').className = m === 'PS' ? 'switch-btn active' : 'switch-btn inactive';
            document.getElementById('tableBtn').className = m === 'TABLE' ? 'switch-btn active' : 'switch-btn inactive';
            document.getElementById('cafeBtn').className = m === 'CAFE' ? 'switch-btn active' : 'switch-btn inactive';

            const playersDiv = document.getElementById('players');
            const tablesDiv = document.getElementById('tables');
            const mainControlsDiv = document.getElementById('mainControls');
            const cafeSectionDiv = document.getElementById('cafeSection');
            const debtSectionDiv = document.getElementById('debtSection');
            const salesHistorySectionDiv = document.getElementById('salesHistorySection');
            const gameStatsTable = document.getElementById('gameStatsTable');

            playersDiv.style.display = (m === 'PC' || m === 'PS') ? 'grid' : 'none';
            tablesDiv.style.display = (m === 'TABLE') ? 'grid' : 'none';
            mainControlsDiv.style.display = (m === 'PC' || m === 'PS') ? 'block' : 'none';
            gameStatsTable.style.display = (m === 'PC' || m === 'PS') ? 'table' : 'none';
            cafeSectionDiv.style.display = (m === 'CAFE') ? 'block' : 'none';
            debtSectionDiv.style.display = (m === 'CAFE') ? 'block' : 'none';
            salesHistorySectionDiv.style.display = (m === 'CAFE') ? 'block' : 'none';

            if (m === 'PC' || m === 'PS') {
                renderPlayers();
            } else if (m === 'TABLE') {
                renderTables();
            } else if (m === 'CAFE') {
                renderCafeMenu();
                renderCurrentOrder();
                renderDebtList();
                updateSalesFilters();
            }
        }
        
        function format(ms) {
            if (ms < 0) ms = 0;
            const totalSeconds = Math.floor(ms / 1000);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            
            if (h > 0) {
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            } else {
                return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            }
        }
        
        // --- âš ï¸ LocalStorage Check & Window Load ---
        function isLocalStorageAvailable() {
            var test = 'test';
            try {
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch(e) { return false; }
        }
        window.onload = () => {
            if (!isLocalStorageAvailable()) {
                alert("Ø¦Ø§Ú¯Ø§Ø¯Ø§Ø±ÛŒ: ÙˆÛØ¨Ú¯Û•Ú•Û•Ú©Û•Øª Ù¾Ø´ØªÚ¯ÛŒØ±ÛŒ Ù„Û• Ø®Û•Ø²Ù†Ú©Ø±Ø¯Ù†ÛŒ Ù†Ø§ÙˆØ®Û†ÛŒÛŒ (localStorage) Ù†Ø§Ú©Ø§Øª ÛŒØ§Ù† Ù„Û• Ø¯Û†Ø®ÛŒ ØªØ§ÛŒØ¨Û•Øª (Private Mode)Ù€Ø¯Ø§ÛŒÛ•. Ù‡ÛŒÚ† Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú© Ù¾Ø§Ø´ Ø¯Ø§Ø®Ø³ØªÙ†ÛŒ Ù¾Û•Ú•Û•Ú©Û• Ù†Ø§Ù…ÛÙ†ÛØªÛ•ÙˆÛ•.");
            }
            
            updateIncomeDisplay();
            updateCafeIncomeDisplay();
            updateTableIncomeDisplay();
            loadReportList();
            renderFoodMenu();
            switchMode('PC'); // Start in PC mode
        };
    </script>
</body>
</html>
